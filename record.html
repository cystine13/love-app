<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë…¹ìŒí•´ì„œ ì‚¬ë‘í•´ ë“±ë¡í•˜ê¸°</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ğŸ¤ ì‚¬ë‘í•´ ë…¹ìŒí•˜ê¸°</h1>

<!-- ë…¹ìŒ ë²„íŠ¼ -->
<button class="primary" onclick="startRecording()">ğŸ”´ ë…¹ìŒ ì‹œì‘</button>
<button class="secondary" onclick="stopRecording()">â¹ ë…¹ìŒ ì¢…ë£Œ</button>

<!-- ë¯¸ë¦¬ë“£ê¸° -->
<audio id="previewAudio" controls style="display:none; margin-top:20px;"></audio>

<hr style="margin:25px 0;">

<!-- íƒœê·¸ ì„ íƒ -->
<h3>ëˆ„ê°€ ë‚˜ì—ê²Œ ì‚¬ë‘í•´ë¼ê³  ë§í–ˆë‚˜ìš”?</h3>

<label><input type="radio" name="fromWhom" value="mom"> ì—„ë§ˆ</label><br>
<label><input type="radio" name="fromWhom" value="dad"> ì•„ë¹ </label><br>
<label><input type="radio" name="fromWhom" value="lover"> ì—°ì¸</label><br>
<label><input type="radio" name="fromWhom" value="friend"> ì¹œêµ¬</label><br>
<label><input type="radio" name="fromWhom" value="child"> ì•„ì´</label><br>
<label><input type="radio" name="fromWhom" value="me"> ë‚˜</label><br>

<label>
  <input type="radio" name="fromWhom" value="custom">
  ì§ì ‘ ì…ë ¥:
</label>
<input type="text" id="customInput" placeholder="ì˜ˆ: ë¯¸ë˜ì˜ ë‚˜">

<hr style="margin:25px 0;">

<!-- ì €ì¥ ë²„íŠ¼ -->
<button class="primary" onclick="saveRecordedVoice()">ì €ì¥í•˜ê¸°</button>

<script src="main.js"></script>

<script>
let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;

// ë…¹ìŒ ì‹œì‘
function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.start();
    alert("ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤!");

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      recordedBlob = new Blob(audioChunks, { type: "audio/webm" });
      const url = URL.createObjectURL(recordedBlob);

      const audio = document.getElementById("previewAudio");
      audio.src = url;
      audio.style.display = "block";
    };
  });
}

// ë…¹ìŒ ì¢…ë£Œ
function stopRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
    alert("ë…¹ìŒì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
  }
}

// base64 ë³€í™˜ í•¨ìˆ˜
function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

// ì €ì¥í•˜ê¸°
async function saveRecordedVoice() {
  if (!recordedBlob) {
    alert("ë…¹ìŒëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤!");
    return;
  }

  const fromWhom = getFromWhom();

  const base64audio = await blobToBase64(recordedBlob);

  addVoice("ë‚´ ë…¹ìŒ", base64audio, fromWhom);

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  location.href = "add.html";
}
</script>

</body>
</html>
