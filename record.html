<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‚¬ë‘í•´ ë…¹ìŒí•˜ê¸°</title>
  <link rel="stylesheet" href="style.css">

  <!-- RecordRTC CDN -->
  <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>

  <style>
    .rec-btn {
      width: 100%;
      background: #FFB5C2;
      padding: 15px;
      border-radius: 14px;
      font-size: 18px;
      border: none;
      margin-bottom: 15px;
    }
    .stop-btn {
      width: 100%;
      background: #FFD6D6;
      padding: 15px;
      border-radius: 14px;
      font-size: 18px;
      border: none;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<h1>ğŸ¤ ì‚¬ë‘í•´ ë…¹ìŒí•˜ê¸°</h1>

<button class="rec-btn" onclick="startRecording()">ğŸ”´ ë…¹ìŒ ì‹œì‘</button>
<button class="stop-btn" onclick="stopRecording()">â¹ ë…¹ìŒ ì¢…ë£Œ</button>

<audio id="preview" controls style="display:none; width:100%; margin-top:15px;"></audio>

<hr>

<h3>ëˆ„ê°€ ë‚˜ì—ê²Œ ì‚¬ë‘í•´ë¼ê³  ë§í–ˆë‚˜ìš”?</h3>
<div id="tagArea">
  <label><input type="radio" name="fromWhom" value="ì—„ë§ˆ"> ì—„ë§ˆ</label><br>
  <label><input type="radio" name="fromWhom" value="ì•„ë¹ "> ì•„ë¹ </label><br>
  <label><input type="radio" name="fromWhom" value="ì—°ì¸"> ì—°ì¸</label><br>
  <label><input type="radio" name="fromWhom" value="ì¹œêµ¬"> ì¹œêµ¬</label><br>
  <label><input type="radio" name="fromWhom" value="ì•„ì´"> ì•„ì´</label><br>
  <label><input type="radio" name="fromWhom" value="ë‚˜"> ë‚˜</label><br>
  <label><input type="radio" name="fromWhom" value="custom"> ì§ì ‘ ì…ë ¥: 
    <input type="text" id="customInput" placeholder="ì˜ˆ: ë¯¸ë˜ì˜ ë‚˜">
  </label>
</div>

<button class="primary" style="margin-top:20px;" onclick="saveVoice()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>

<script>
let recorder; 
let recordedBlob;

// ------------------------------------------------------------
// ë…¹ìŒ ì‹œì‘
// ------------------------------------------------------------
async function startRecording() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  recorder = RecordRTC(stream, {
    type: "audio",
    mimeType: "audio/wav",
    desiredSampRate: 16000
  });

  recorder.startRecording();
  alert("ë…¹ìŒì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!");
}

// ------------------------------------------------------------
// ë…¹ìŒ ì¢…ë£Œ
// ------------------------------------------------------------
function stopRecording() {
  if (!recorder) return alert("ë…¹ìŒì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

  recorder.stopRecording(() => {
    recordedBlob = recorder.getBlob();

    const audioURL = URL.createObjectURL(recordedBlob);
    const audio = document.getElementById("preview");
    audio.src = audioURL;
    audio.style.display = "block";

    alert("ë…¹ìŒì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤!");
  });
}

// ------------------------------------------------------------
// íƒœê·¸ ì„ íƒ
// ------------------------------------------------------------
function getFromWhom() {
  const checked = document.querySelector("input[name='fromWhom']:checked");
  if (!checked) return "ë‚˜";

  if (checked.value === "custom") {
    const t = document.getElementById("customInput").value.trim();
    return t !== "" ? t : "ë‚˜";
  }
  return checked.value;
}

// ------------------------------------------------------------
// localStorage ë“±ë¡
// ------------------------------------------------------------
function saveVoice() {
  if (!recordedBlob) {
    alert("ë…¹ìŒì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
    return;
  }

  const fromWhom = getFromWhom();
  const fileUrl = URL.createObjectURL(recordedBlob);

  let all = JSON.parse(localStorage.getItem("allVoices") || "[]");

  all.push({
    id: crypto.randomUUID(),
    title: "ë‚´ ë…¹ìŒ",
    fileUrl,
    fromWhom,
    createdAt: Date.now()
  });

  localStorage.setItem("allVoices", JSON.stringify(all));

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  location.href = "add.html";
}
</script>

</body>
</html>
